{% extends "base.html" %}
{% block title %}–ê–¥–º—ñ–Ω-–•–∞–±{% endblock %}

{% block content %}
{% if admin_granted %}
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-900">üõ†Ô∏è –ü–∞–Ω–µ–ª—å –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>

        <div id="msgBox" class="hidden p-4 rounded mb-6 text-center font-bold shadow-md transition-all sticky top-20 z-50"></div>

        <div class="flex border-b border-gray-300 mb-6">
            <button onclick="switchTab('products')" id="tab-products" class="tab-btn px-6 py-3 font-bold text-blue-600 border-b-2 border-blue-600">
                üì¶ –¢–æ–≤–∞—Ä–∏
            </button>
            <button onclick="switchTab('feedback')" id="tab-feedback" class="tab-btn px-6 py-3 font-bold text-gray-500 hover:text-blue-500">
                üí¨ –í—ñ–¥–≥—É–∫–∏
            </button>
            <button onclick="switchTab('orders')" id="tab-orders" class="tab-btn px-6 py-3 font-bold text-gray-500 hover:text-blue-500">
                üìú –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è
            </button>
        </div>

        <div id="view-products" class="tab-content">
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-l-8 border-green-500">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-gray-800">‚ú® –î–æ–¥–∞—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç</h2>
                <form id="addForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="name" required class="border rounded p-2" placeholder="–ù–∞–∑–≤–∞">
                    <input type="number" id="price" required class="border rounded p-2" placeholder="–¶—ñ–Ω–∞">
                    <select id="category" class="border rounded p-2">
                        <option value="–ê—Ä—Ç–µ—Ñ–∞–∫—Ç–∏">–ê—Ä—Ç–µ—Ñ–∞–∫—Ç–∏</option>
                        <option value="–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏">–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏</option>
                        <option value="–ù–∞—Å—ñ–Ω–Ω—è">–ù–∞—Å—ñ–Ω–Ω—è</option>
                        <option value="–¢–≤–∞—Ä–∏–Ω–∏">–¢–≤–∞—Ä–∏–Ω–∏</option>
                        <option value="–ó–±—Ä–æ—è">–ó–±—Ä–æ—è</option>
                    </select>
                    <input type="text" id="image" class="border rounded p-2" value="/static/images/shop/Prismatic_Shard.png">
                    <button type="submit" class="md:col-span-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded shadow">
                        üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ (POST API)
                    </button>
                </form>
            </div>
            <div id="productsList" class="grid grid-cols-1 gap-3"></div>
        </div>

        <div id="view-feedback" class="tab-content hidden">
            
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-l-8 border-yellow-500">
                <h2 class="text-xl font-bold mb-4 text-gray-800">‚úçÔ∏è –°—Ç–≤–æ—Ä–∏—Ç–∏ –í—ñ–¥–≥—É–∫ (–ó –ü–µ—Ä–µ–≤—ñ—Ä–∫–æ—é Email)</h2>
                <form id="addFeedbackForm" class="space-y-3">
                    <input type="text" id="feedbackUsername" required class="border rounded p-2" placeholder="–í–∞—à Username">
                    <input type="email" id="feedbackEmail" required class="border rounded p-2" placeholder="–í–∞—à Email (–¥–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó)">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <textarea id="feedbackText" required class="col-span-2 border rounded p-2 focus:ring-2 focus:ring-yellow-400" placeholder="–¢–µ–∫—Å—Ç –≤—ñ–¥–≥—É–∫—É..."></textarea>
                        <select id="feedbackRating" class="border rounded p-2 bg-white">
                            <option value="5">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è (–Ü—Ä–∏–¥—ñ—î–≤–∞ —è–∫—ñ—Å—Ç—å)</option>
                            <option value="4">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</option>
                            <option value="3">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</option>
                            <option value="2">‚≠êÔ∏è‚≠êÔ∏è</option>
                            <option value="1">‚≠êÔ∏è (–°–º—ñ—Ç—Ç—è)</option>
                        </select>
                        <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded shadow">
                            –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ (POST API)
                        </button>
                    </div>
                </form>
            </div>

            <h2 class="text-xl font-bold mb-4">–ú–æ–¥–µ—Ä–∞—Ü—ñ—è –í—ñ–¥–≥—É–∫—ñ–≤</h2>
            <div id="feedbackList" class="space-y-4"></div>
        </div>

        <div id="view-orders" class="tab-content hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-l-8 border-blue-500">
                <h2 class="text-xl font-bold mb-4 text-gray-800">üì¶ –°—Ç–≤–æ—Ä–∏—Ç–∏ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è (–ü–æ—Ç—Ä—ñ–±–µ–Ω —ñ—Å–Ω—É—á–∏–π Email)</h2>
                <form id="addOrderForm" class="space-y-3">
                    <p class="font-semibold text-sm">–î–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ):</p>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="orderUsername" required class="border rounded p-2" placeholder="Username">
                        <input type="email" id="orderEmail" required class="border rounded p-2" placeholder="Email">
                    </div>
                    
                    <p class="font-semibold text-sm pt-2">–¢–æ–≤–∞—Ä–∏ (ID —ñ –ö—ñ–ª—å–∫—ñ—Å—Ç—å —á–µ—Ä–µ–∑ –∫–æ–º—É):</p>
                    <input type="text" id="orderItems" required class="w-full border rounded p-2" placeholder="–ù–∞–ø—Ä: 1:1, 3:2 (ID —Ç–æ–≤–∞—Ä—É : –ö—ñ–ª—å–∫—ñ—Å—Ç—å)">
                    
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow">
                        –û—Ñ–æ—Ä–º–∏—Ç–∏ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è (POST API)
                    </button>
                </form>
            </div>
            
            <h2 class="text-xl font-bold mb-4">–Ü—Å—Ç–æ—Ä—ñ—è –ó–∞–º–æ–≤–ª–µ–Ω—å</h2>
            <div id="ordersList" class="space-y-4"></div>
        </div>
    </div>
    <script>
        const API_BASE = '/api/v1';

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function showMsg(text, type='success') {
            const box = document.getElementById('msgBox');
            box.textContent = text;
            box.className = type === 'error' 
                ? 'bg-red-100 text-red-800 p-4 rounded mb-6 text-center font-bold shadow block'
                : 'bg-green-100 text-green-800 p-4 rounded mb-6 text-center font-bold shadow block';
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 4000);
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                btn.classList.add('text-gray-500');
            });
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            activeBtn.classList.remove('text-gray-500');

            if (tabName === 'products') loadProducts();
            if (tabName === 'feedback') loadFeedback();
            if (tabName === 'orders') loadOrders();
        }

        // === 1. PRODUCTS (CRUD) ===
        async function loadProducts() {
            const list = document.getElementById('productsList');
            const res = await fetch(`${API_BASE}/products`);
            const products = await res.json();
            
            list.innerHTML = products.map(p => `
                <div class="flex items-center justify-between p-3 bg-white rounded border hover:shadow">
                    <div class="flex items-center gap-3">
                        <img src="${p.image}" class="w-10 h-10 object-contain" onerror="this.src='/static/images/shop/Pumpkin.png'">
                        <div>
                            <div class="font-bold">${p.name}</div>
                            <div class="text-xs text-gray-500">${p.category}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-yellow-600">${p.price}g</span>
                        <button onclick="deleteItem('products', ${p.id}, '${p.name}')" class="text-red-500 hover:text-red-700 font-bold">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('name').value,
                price: parseFloat(document.getElementById('price').value),
                category: document.getElementById('category').value,
                image: document.getElementById('image').value
            };
            
            if(data.price < 0) return showMsg("–¶—ñ–Ω–∞ –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –º—ñ–Ω—É—Å–æ–≤–æ—é!", 'error');

            const res = await fetch(`${API_BASE}/products`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });

            if(res.ok) { showMsg("–¢–æ–≤–∞—Ä –¥–æ–¥–∞–Ω–æ!"); loadProducts(); e.target.reset(); } 
            else { showMsg("–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è", 'error'); }
        });


        // === 2. FEEDBACK (CREATE & DELETE) ===
        async function loadFeedback() {
            const list = document.getElementById('feedbackList');
            const res = await fetch(`${API_BASE}/feedback`);
            const data = await res.json();
            
            list.innerHTML = data.map(f => `
                <div class="bg-amber-50 p-4 rounded border border-amber-200 relative">
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold text-amber-900">${f.username} <span class="text-yellow-600">${'‚òÖ'.repeat(f.rating)}</span></h4>
                        <button onclick="deleteItem('feedback', ${f.id}, '${f.username}')" class="text-red-400 hover:text-red-600 text-sm font-bold">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                    </div>
                    <p class="text-gray-700 mt-1">${f.text}</p>
                    <div class="text-xs text-gray-400 mt-2">${f.created_at}</div>
                </div>
            `).join('');
        }

        document.getElementById('addFeedbackForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('feedbackEmail').value;
            if (!isValidEmail(email)) {
                return showMsg("‚ùå –ü–æ–º–∏–ª–∫–∞: –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç Email (–ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ '@' —ñ –¥–æ–º–µ–Ω)", 'error');
            }

            const data = {
                username: document.getElementById('feedbackUsername').value,
                email: email, // Email –¥–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
                text: document.getElementById('feedbackText').value,
                rating: parseInt(document.getElementById('feedbackRating').value)
            };
            
            const res = await fetch(`${API_BASE}/feedback`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            const result = await res.json();

            if(res.ok) { 
                showMsg(`‚úÖ –í—ñ–¥–≥—É–∫ –≤—ñ–¥ ${data.username} –¥–æ–¥–∞–Ω–æ.`); 
                loadFeedback();
                e.target.reset();
            } else {
                showMsg(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${result.error}`, 'error');
            }
        });


        // === 3. ORDERS (CREATE & READ) ===
        async function loadOrders() {
            const list = document.getElementById('ordersList');
            const res = await fetch(`${API_BASE}/orders`);
            const data = await res.json();
            
            if (data.error) {
                 list.innerHTML = `<div class="text-red-500 font-bold p-4 bg-red-50 rounded">${data.error}</div>`;
                 return;
            }

            list.innerHTML = data.map(o => `
                <div class="bg-blue-50 p-4 rounded border border-blue-200 flex justify-between items-center">
                    <div>
                        <div class="font-bold text-blue-900">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #${o.id} <span class="text-sm font-normal text-gray-600">–≤—ñ–¥ ${o.username}</span></div>
                        <div class="text-xs text-gray-400 mt-2">${o.created_at}</div>
                    </div>
                    <div class="text-xl font-bold text-green-600">${o.total_price}g</div>
                </div>
            `).join('');
        }

        document.getElementById('addOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('orderEmail').value;
            if (!isValidEmail(email)) {
                return showMsg("‚ùå –ü–æ–º–∏–ª–∫–∞: –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç Email –¥–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è", 'error');
            }

            // –†–æ–∑–±—ñ—Ä —Ç–æ–≤–∞—Ä—ñ–≤ (1:1, 3:2)
            const itemsString = document.getElementById('orderItems').value;
            const items = itemsString.split(',').map(item => {
                const [product_id, quantity] = item.split(':').map(s => parseInt(s.trim()));
                return { product_id, quantity };
            }).filter(item => item.product_id && item.quantity);

            if (items.length === 0) {
                return showMsg("‚ùå –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∫–∞–∂—ñ—Ç—å —Ç–æ–≤–∞—Ä–∏ (–Ω–∞–ø—Ä: 1:1, 3:2)", 'error');
            }

            const data = {
                username: document.getElementById('orderUsername').value,
                email: email,
                items: items
            };
            
            const res = await fetch(`${API_BASE}/orders`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            const result = await res.json();

            if(res.ok) { 
                showMsg(`‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #${result.order_id} —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ.`); 
                loadOrders();
                e.target.reset();
            } else {
                showMsg(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${result.error}`, 'error');
            }
        });

        // === –£–ù–Ü–í–ï–†–°–ê–õ–¨–ù–ï –í–ò–î–ê–õ–ï–ù–ù–Ø (DELETE) ===
        async function deleteItem(type, id, name) {
            if(!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ ${name} (${type})?`)) return;

            const res = await fetch(`${API_BASE}/${type}/${id}`, { method: 'DELETE' });
            
            if (res.ok) {
                showMsg(`üóëÔ∏è ${name} –≤–∏–¥–∞–ª–µ–Ω–æ.`);
                if (type === 'products') loadProducts();
                if (type === 'feedback') loadFeedback();
            } else {
                const err = await res.json();
                showMsg(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ${err.error || res.status}`, 'error');
            }
        }

        // –°—Ç–∞—Ä—Ç
        window.onload = () => switchTab('products');
    </script>


{% else %}
    <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-xl border-l-4 border-red-600">
        <h1 class="text-2xl font-bold mb-6 text-center text-red-700">üîí –î–æ—Å—Ç—É–ø –¥–æ –ê–¥–º—ñ–Ω-–ü–∞–Ω–µ–ª—ñ</h1>
        <p class="text-gray-600 mb-4 text-center">–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —Ç–∏–º—á–∞—Å–æ–≤–∏–π –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó.</p>
        
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="bg-red-100 text-red-700 p-3 rounded mb-4 border border-red-200">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="post">
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">–ü–∞—Ä–æ–ª—å (0000)</label>
                <input type="password" name="passcode" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 focus:ring-2 focus:ring-red-400">
            </div>
            <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded shadow-lg transition">
                –£–≤—ñ–π—Ç–∏
            </button>
        </form>
    </div>
{% endif %}

{% endblock %}